---
title: "세종대왕의 세법개혁과 국민투표 (ggplot) "
output: html_document
---

## Data 

원자료는 [세종실록](http://sillok.history_go_kr/id/kda_11208010_005), 요약표는 오기수 교수의 논문에서.

```{r, data, out.width = "80%", fig.align = "center"}
knitr::include_graphics("../pics/sejong_ref_data.png")
```

```{r, echo = FALSE, message = FALSE, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(magrittr)
library(ggplot2)
library(grid)
library(gridExtra)
library(extrafont)
load("sejong_ref_tbl.RData")
str(sejong_ref)
```

```{r, echo = FALSE, results = 'asis'}
vnames_kr <- c("집계", "찬반", "계급", "지역", "신분")
sejong_ref %>% 
  `[`(c(4, 3, 5, 2, 1)) %>%
  kable(col.names = vnames_kr %>% `[`(c(4, 3, 5, 2, 1)), align = "r")
```

<P style = "page-break-before:always">

## 전체 찬반

```{r, overall votes}
Vote_df <- aggregate(Counts ~ Vote, 
                     data = sejong_ref, 
                     FUN = sum)
Vote_df
```

<P style = "page-break-before:always">

### 원형그래프

```{r, message = FALSE}
n_vote <- Vote_df %>% 
  `[`(, 1) %>% 
  levels %>% 
  length
# pos <- function(x) {cumsum(x) - x / 2}
pos <- . %>% {
  `-`(cumsum(.), `/`(., 2))
  }
y_coord <- Vote_df$Counts %>%
  pos 
# pie_label <- paste(levels(vote_df$vote), 
#                    format(vote_df$Freq, big.mark = ","), sep = "\n") 
pie_label <- Vote_df %>% 
  .$Vote %>% 
  levels %>% 
  paste(Vote_df %>% 
          .$Counts %>% 
          format(big.mark = ","), sep = "\n") 
pie_label
# kable(vote_df, align = "r")
Vote_df %>% 
  kable(align = "r")
# str(vote_df)
Vote_df %>% 
  str
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
# p1 <- ggplot(data = vote_df, mapping = aes(x = "", y = Freq, fill = vote))
p1 <- ggplot(data = Vote_df, 
             mapping = aes(x = "", 
                           y = Vote_df[, 2], 
                           fill = Vote_df[, 1])) 
p2 <- p1 + 
  geom_bar(width = 1, 
           stat = "identity", 
           position = position_stack(reverse = TRUE))
p2
p2_2 <- p1 + 
  geom_bar(width = 1, 
           stat = "identity", 
           position = "dodge")
p2_2
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p3_2 <- p2_2 + 
  theme_bw(base_family = "KoPubWorldDotum Medium") 
p3_2
p4_2 <- p3_2 + 
  scale_x_discrete(name = "찬반") +
  scale_y_continuous(name = "집계", 
                     breaks = Vote_df[, 2], 
                     labels = format(Vote_df[, 2], 
                                     big.mark = ",")) +
  theme(axis.title.x = element_text(family = "KoPubWorldDotum Medium"),
        axis.title.y = element_text(family = "KoPubWorldDotum Medium"))
p4_2
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p5_2 <- p4_2 +
  scale_fill_manual(name = "찬반", 
                    values = rainbow(n_vote)[n_vote:1], 
                    labels = Vote_df$Vote) +
  theme(legend.title = element_text(family = "KoPubWorldDotum Bold"),
        legend.text = element_text(family = "KoPubWorldDotum Light"))
p5_2
p6_2 <- p5_2 +
  geom_text(aes(y = Vote_df[, 2] / 2), 
            label = format(Vote_df[, 2], 
                           big.mark = ","), 
            family = "KoPubWorldDotum Medium", 
            position = position_dodge(width = 1))
p6_2
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p7_2 <- p6_2 +
  theme(legend.position = c(0.25, 0.75))
p7_2
p8_2 <- p5_2 +
  guides(fill = "none") +
  geom_text(aes(y = Vote_df[, 2] / 2),
            family = "KoPubWorldDotum Medium", 
            label = pie_label,
            position = position_dodge(width = 1))
p8_2
# ggsave("../pics/sejong_geom_bar_total_ggplot.png", p7_2, dpi = 72)
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p3 <- p2 + 
  theme_bw(base_family = "KoPubWorldDotum Medium")
p3 
p4 <- p3 + 
  scale_x_discrete(name = "찬반") +
  scale_y_continuous(name = "집계", 
                     breaks = cumsum(Vote_df[, 2]), 
                     labels = format(cumsum(Vote_df[, 2]), big.mark = ","))
p4
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p5 <- p4 +
  scale_fill_manual(name = "찬반", 
                    values = rainbow(2)[2:1], 
                    labels = Vote_df[, 1])
p5
p6 <- p5 + 
  geom_text(aes(y = y_coord), 
            label = format(Vote_df[, 2], big.mark = ","), 
            family = "KoPubWorldDotum Medium", 
            position = position_identity())  
p6
# ggsave("../pics/sejong_geom_bar_total_ggplot_stack.png", p6, dpi = 72)
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
p7 <- p6 +
  theme(legend.position = c(0.75, 0.75))
p7
p8 <- p5 + 
  guides(fill = "none") +
  geom_text(aes(y = y_coord),
            label = pie_label,
            family = "KoPubWorldDotum Medium", 
            position = position_identity())
p8
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
pie_total_1 <- p2 + 
  coord_polar(theta = "y", 
              start = 3 * pi /2 , 
              direction = -1)
pie_total_1
pie_total_2 <- pie_total_1 + 
  scale_y_continuous(name = "", 
                     breaks = NULL) +
  scale_x_discrete(name = "") 
pie_total_2
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
pie_total_3 <- pie_total_2 +
  scale_fill_manual(name = "", 
                    values = rainbow(n_vote)[n_vote:1])
pie_total_3
pie_total_4 <- pie_total_3 +
  theme_void(base_family = "KoPubWorldDotum Medium")
pie_total_4
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 3.2, fig.height = 3.2}
pie_total_5 <- pie_total_4 +
  guides(fill = "none")
pie_total_5
pie_total_6 <- pie_total_5 +
  geom_text(aes(y = y_coord), 
            label = pie_label, 
            family = "KoPubWorldDotum Medium", 
            position = position_identity())
pie_total_6
```

<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 4, fig_height = 4}
pie_total_7 <- pie_total_6 +
  ggtitle("전체 찬반") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
#  theme(plot.margin = unit(c(1, 1, 1.5, 1), "lines"), 
        plot.title = element_text(hjust = 0.5, size = 20))
pie_total_7
ggsave("../pics/sejong_total_pie_ggplot.png", pie_total_7, dpi = 72)
```

<P style = "page-break-before:always">

#### `pie_gg()`


```{r, pie_gg2, eval = FALSE}
pie_gg <- function(df){
  n <- length(names(df))
  y_coord <- cumsum(df[, 2]) - df[, 2] / 2
  pie_label <- paste(levels(df[, 1]), 
                     format(df[, 2], big.mark = ","), 
                     sep = "\n") 
  ggplot(df, aes(x = "", 
                 y = df[, 2], 
                 fill = df[, 1])) + 
    geom_bar(width = 1, 
             stat = "identity", 
             position = position_stack(reverse = TRUE)) +
    geom_text(aes(y = y_coord), 
              label = pie_label, 
              size = 5,
              family = "KoPubWorldDotum Medium",
              position = position_identity()) +
    guides(fill = "none") +
    theme_void() +
    coord_polar(theta = "y", 
                start = 3 * pi / 2, 
                direction = -1)
  }
dump("pie_gg", 
     file = "./pie_gg.R")
```

```{r, pie_gg_new}
pie_gg_new <-
function(df){
  n <- length(names(df))
  y_coord <- cumsum(df[, 2]) - df[, 2] / 2
  pie_label <- paste(levels(df[, 1]), 
                     format(df[, 2], big.mark = ","), 
                     sep = "\n") 
  pie <- ggplot(df, aes(x = "", 
                        y = df[, 2], 
                        fill = df[, 1])) + 
    geom_bar(width = 1, 
             stat = "identity", 
             position = position_stack(reverse = TRUE)) +
  #  geom_text(aes(y = y_coord), 
  #            label = pie_label, 
  #            size = 5,
  #            family = "KoPubWorldDotum Medium",
  #            position = position_identity()) +
    guides(fill = "none") +
    theme_void() +
    coord_polar(theta = "y", 
                start = 3 * pi / 2, 
                direction = -1)
  list(pie = pie, df = df, pie_label = pie_label, y_coord = y_coord)
}
dump("pie_gg_new", 
     file = "./pie_gg_new.R")
```


<P style = "page-break-before:always">

```{r, message = FALSE, fig.width = 4, fig_height = 4}
source("pie_gg_new.R")
pie_list <- pie_gg_new(Vote_df)
pie_list$pie
pie_list$df
pie_list$pie_label
pie_list$y_coord
# pie_gg_new(Vote_df) +
pie_list$pie +
  geom_text(aes(y = pie_list$y_coord), 
            label = pie_list$pie_label, 
            size = 5,
            family = "KoPubWorldDotum Medium",
            position = position_identity()) +
  scale_fill_manual(values = rainbow(2)[2:1]) +
  ggtitle("전체 찬반") +
  theme(plot.margin = unit(c(1, 1, 1, 1), "line"),
        plot.title = element_text(hjust = 0.5, 
                                  size = 20,
                                  family = "KoPubWorldDotum Bold"))
```

<P style = "page-break-before:always">

# 계급 및 지역별 찬반

## 계급별 찬반

```{r, vote by classes}
Vote_Class %>%
  format(big.mark = ",") %>%
  kable(align = "r", caption = "계급별 찬반")
# kable(format(Vote_Class, 
#              big.mark = ","), 
#       align = "r", 
#       caption = "계급별 찬반")
Vote_Class %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 3, nsmall = 1) %>%
  kable(align = "r", caption = "계급별 찬반(%)")
# kable(format(prop.table(Vote_Class, 
#                         margin = 2) * 100, 
#              digits = 3, 
#              nsmall = 1), 
#       align = "r", 
#       caption = "계급별 찬반(%)")
```

## 품관촌민 별도 분석

품관촌민의 수효가 상대적으로 많아서

```{r, vote by class2}
Vote_Class_2 %>%
  format(big.mark = ",") %>%
  kable(align = rep("r", 2), caption = "품관촌민")
# kable(format(Vote_Class_2, 
#              big.mark = ","), 
#       align = rep("r", 2), 
#       caption = "품관촌민")
```

소계를 교차표의 주변에 계산

```{r}
Vote_Class_2 %>% 
  cbind("계" = rowSums(.)) %>% 
  rbind("계" = colSums(.)) %>%
  format(big.mark = ",") %>%
  kable(caption = "마진 합 추가", align = "r") 
```

백분율을 계산하여 주변에 집계. 

```{r, Percentage}
Vote_Class_2 %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 3, nsmall = 1) %>%
  kable(align = "r", caption = "관료와 품관촌민(%)")
# kable(format(prop.table(Vote_Class_2, 
#                         margin = 2) * 100, 
#              digits = 3, nsmall = 1), 
#       caption = "관료와 품관촌민(%)", 
#       align = "r")
```

### data frame 변환

```{r, message = FALSE}
# Vote_Class_2_df <- as.data.frame(Vote_Class_2)
Vote_Class_2_df <- aggregate(Counts ~ Vote + Class_2,
                             data = sejong_ref,
                             FUN = sum)
vnames_class_kr <- c("찬반", "계급", "집계")
Vote_Class_2_df %>%
  format(big.mark = ",") %>%
  kable(align = c('c', 'c', 'r'), 
        col.names = vnames_class_kr, 
        caption = "관료와 품관촌민")
# kable(format(Vote_Class_2_df, 
#              big.mark = ","), 
#       align = c('c', 'c', 'r'), 
#       col.names = vnames_class_kr, 
#       caption = "관료와 품관촌민")
Vote_bureaus_df <- subset(Vote_Class_2_df, 
                          Vote_Class_2_df$Class_2 == "관료", 
                          select = c("Vote", "Counts"))
Vote_bureaus_df %>%
  format(big.mark = ",") %>%
  kable(align = 'r', 
      col.names = vnames_class_kr[-2], 
      caption = "관료의 찬반")
# kable(format(Vote_bureaus_df, 
#              big.mark = ","), 
#       align = 'r', 
#       col.names = vnames_class_kr[-2], 
#       caption = "관료의 찬반")
Vote_commons_df <- subset(Vote_Class_2_df, 
                          Vote_Class_2_df$Class_2 == "품관촌민", 
                          select = c("Vote", "Counts"))
Vote_commons_df %>%
  format(big.mark = ",") %>%
  kable(align = 'r', 
      row.names = FALSE, 
      col.names = vnames_class_kr[-2], 
      caption = "품관촌민의 찬반")
# kable(format(Vote_commons_df, 
#              big.mark = ","), 
#       align = 'r', 
#       row.names = FALSE, 
#       col.names = vnames_class_kr[-2], 
#      caption = "품관촌민의 찬반")
```

<P style = "page-break-before:always">

### 원형그래프

```{r, coord_polar_2, message = FALSE, fig.width = 8, fig.height = 4}
pie_list2 <- pie_gg_new(Vote_bureaus_df)
pie_bureaus <- pie_list2$pie +  
  geom_text(aes(y = pie_list2$y_coord), 
            label = pie_list2$pie_label, 
            size = 5,
            family = "KoPubWorldDotum Medium",
            position = position_identity()) +
  scale_fill_manual(values = rainbow(2)[2:1]) +
  ggtitle("관료의 찬반") +
  theme(plot.margin = unit(c(1, 1, 1, 1), "line"),
        plot.title = element_text(hjust = 0.5, 
                                  size = 20,
                                  family = "KoPubWorldDotum Bold"))
pie_list3 <- pie_gg_new(Vote_commons_df)
pie_commons <- pie_list3$pie +  
  geom_text(aes(y = pie_list3$y_coord), 
            label = pie_list3$pie_label, 
            size = 5,
            family = "KoPubWorldDotum Medium",
            position = position_identity()) +
  scale_fill_manual(values = rainbow(2)[2:1]) +
  ggtitle("품관촌민의 찬반") +
  theme(plot.margin = unit(c(1, 1, 1, 1), "line"),
        plot.title = element_text(hjust = 0.5, 
                                  size = 20,
                                  family = "KoPubWorldDotum Bold"))
pies_grid <- grid.arrange(pie_bureaus, 
                          pie_commons, 
                          ncol = 2, 
                          top = "")
pies_grid
ggsave("../pics/sejong_bureaus_commons_pie_ggplot.png", pies_grid, width = 8, height = 4, dpi = 72)
```
<P style = "page-break-before:always">

## 지역별 찬반

### 관료와 품관촌민

```{r, by region}
Vote_Region_bureaus %>%
  kable(caption = "관료들의 지역별 찬반")
# kable(Vote_Region_bureaus, caption = "관료들의 지역별 찬반")
Vote_Region_bureaus %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 3, nsmall = 1) %>%
  kable(align = "r", caption = "관료들의 지역별 찬반(%)")
# kable(format(prop.table(Vote_Region_bureaus, margin = 2) * 100, digits = 3, nsmall = 1), 
#       align = rep("r", 9), caption = "관료들의 지역별 찬반(%)")
Vote_Region_commons %>%
  format(big.mark = ",") %>%
  kable(align = "r", caption = "품관촌민들의 지역별 찬반")
# kable(format(Vote_Region_commons, big.mark = ","), 
#       align = "r", caption = "품관촌민들의 지역별 찬반")
Vote_Region_commons %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 1, nsmall = 1) %>%
  kable(align = "r", caption = "품관촌민들의 지역별 찬반(%)")
# kable(format(prop.table(Vote_Region_commons, margin = 2) * 100, digits = 1, nsmall = 1), 
#       align = "r", caption = "품관촌민들의 지역별 찬반(%)")
```

## 서울의 찬반

```{r, Seoul}
Vote_seoul_Class %>%
  kable(caption = "서울의 찬반")
# kable(Vote_seoul_Class, caption = "서울의 찬반")
Vote_seoul_Class %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 1, nsmall = 1) %>%
  kable(align = "r", caption = "서울의 찬반(%)")
# kable(format(prop.table(Vote_seoul_Class, margin = 2) * 100, digits = 1, nsmall = 1), 
#      align = "r", caption = "서울의 찬반(%)")
```

<P style = "page-break-before:always">

### 막대그래프

##### Stack

```{r, seoul geom_bar stack, fig.width = 6, fig_height = 4.5}
# Vote_seoul_df <- as.data.frame(Vote_seoul_Class)
Vote_seoul_df <- aggregate(Counts ~ Vote + Class,
                           data = subset(sejong_ref, Region == "서울"),
                           FUN = sum)
n_fill <- length(levels(Vote_seoul_df[, 1]))
x_stack <- Vote_seoul_df[, 2]
y_stack <- unlist(tapply(Vote_seoul_df[, 3], 
                         Vote_seoul_df[, 2], 
                         function(x){
                           cumsum(x) - x / 2
                           }))
y_breaks <- unlist(tapply(Vote_seoul_df[, 3], 
                          Vote_seoul_df[, 2], 
                          cumsum))
y_label <- format(y_breaks, big.mark = ",")
b1_seoul <- ggplot(Vote_seoul_df, 
                   aes(x = x_stack, 
                       y = Vote_seoul_df[, 3], 
                       fill = Vote_seoul_df[, 1])) +
  geom_bar(stat = "identity", 
           position = position_stack(reverse = TRUE))
b1_seoul
b2_seoul <- b1_seoul +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  scale_x_discrete(name = "계급") +
  scale_y_continuous(name = "집계", 
                     breaks = y_breaks, 
                     labels = y_label) +
  scale_fill_manual(name = "찬반", 
                    values = rainbow(n_fill)[n_fill:1], 
                    labels = Vote_seoul_df[, 1])
b2_seoul  
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
b3_seoul <- b2_seoul +
# geom_text(aes(y = y_stack/2), label = Vote_seoul_df$Freq)
  geom_text(aes(y = y_stack), 
            label = Vote_seoul_df[, 3], 
            position = "identity")+
  ggtitle("서울의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold")) 
b3_seoul
ggsave("../pics/sejong_seoul_barplot_stack_ggplot.png", b3_seoul, width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

#### Dodge

```{r, seoul geom_bar dodge, fig.width = 6, fig_height = 4.5}
n_fill <- length(levels(Vote_seoul_df[, 1]))
b1_seoul_dodge <- ggplot(Vote_seoul_df, 
                         aes(x = x_stack, 
                             y = Vote_seoul_df[, 3], 
                             fill = Vote_seoul_df[, 1])) +
  geom_bar(stat = "identity", position = "dodge")
b1_seoul_dodge
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
b2_seoul_dodge <- b1_seoul_dodge +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  scale_x_discrete(name = "계급") +
  scale_y_continuous(name = "집계", 
                     breaks = Vote_seoul_df[, 3], 
                     labels = Vote_seoul_df[, 3]) +
  scale_fill_manual(name = "찬반", 
                    values = rainbow(n_fill)[n_fill:1], 
                    labels = Vote_seoul_df[, 1])
b2_seoul_dodge  
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
#  N <- nrow(Vote_seoul_df)
#  index <- as.vector(matrix(1:N, nrow = 2)[2:1, ])
y_label <- Vote_seoul_df[, 3]
# y_label <- unlist(tapply(Vote_seoul_df[, 3], 
#                                  Vote_seoul_df[, 2],
#                                 rev))
b3_seoul_dodge <- b2_seoul_dodge +
  geom_text(aes(y = Vote_seoul_df[, 3] / 2), 
#            label = Vote_seoul_df[index, "Freq"], 
            label = y_label,
            position = position_dodge(width = 0.9)) +
  ggtitle("서울의 찬반")
b3_seoul_dodge
# ggsave("../pics/sejong_seoul_barplot_dodge_ggplot.png", b3_seoul_dodge, width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

#### Fill

```{r, seoul geom_bar fill, fig.width = 6, fig_height = 4.5}
n_fill <- length(levels(Vote_seoul_df[, 1]))
y_fill <- unlist(tapply(Vote_seoul_df[, 3], 
                        x_stack, 
                        function(x){cumsum(x) / sum(x)}))
p_fill <- unlist(tapply(Vote_seoul_df[, 3], 
                        x_stack, 
                        function(x){(cumsum(x) - x / 2) / sum(x)}))
#                         function(x){(x / 2 + c(0, cumsum(head(x, -1))))/sum(x)}))
b1_seoul_fill <- ggplot(Vote_seoul_df, 
                        aes(x = x_stack, 
                            y = Vote_seoul_df[, 3], 
                            fill = Vote_seoul_df[, 1])) +
  geom_bar(stat = "identity", 
           position = position_fill(reverse = TRUE))
b1_seoul_fill
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
b2_seoul_fill <- b1_seoul_fill +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  scale_x_discrete(name = "계급") +
  scale_y_continuous(name = "집계(%)", 
                     breaks = y_fill, 
                     labels = format(y_fill * 100, 
                                     digits = 2, 
                                     nsmall = 1)) +
  scale_fill_manual(name = "찬반", 
                    values = rainbow(n_fill)[n_fill:1], 
                    labels = Vote_seoul_df[, 1])
b2_seoul_fill  
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
b3_seoul_fill <- b2_seoul_fill +
  geom_text(aes(y = p_fill), 
            label = Vote_seoul_df[, 3], 
            position = "identity") +
  ggtitle("서울의 찬반") 
b3_seoul_fill
# ggsave("../pics/sejong_seoul_barplot_fill_ggplot.png", b3_seoul_fill, width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

### barplot_gg

#### Stack 

```{r, stack}
barplot_gg_stack <- function(df){
n_fill <- length(levels(df[, 1]))
x <- df[, 2]
y <- unlist(tapply(df[, 3], 
                   x, 
                   function(x){cumsum(x) - x / 2}))
y_breaks <- unlist(tapply(df[, 3], 
                          x, 
                          cumsum))
y_label <- format(y_breaks, big.mark = ",")
delta <- (max(y_breaks) - min(y_breaks)) / 20
y_breaks_sort <- sort(y_breaks)
diff(y_breaks_sort) < delta 
index <- which(diff(y_breaks_sort)  > delta)
y_breaks <- c(0, y_breaks_sort[c(index, length(y_breaks_sort))])
y_label <- format(y_breaks, big.mark = ",")
ggplot(df, 
       aes(x = x, 
           y = df[, 3], 
           fill = df[, 1])) +
  geom_bar(stat = "identity", 
           position = position_stack(reverse = TRUE)) +
  scale_y_continuous(breaks = y_breaks,
                     labels = y_label) +
  geom_text(aes(y = y), 
            label = format(ifelse(df[, 3] == 0, "", df[, 3]), 
                           big.mark = ","), 
            position = "identity")
}
barplot_gg_stack(Vote_seoul_df) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold")) 
```

<P style = "page-break-before:always">

#### Dodge

```{r, dodge}
barplot_gg_dodge <- function(df){
n_fill <- length(levels(df[, 1]))
x <- df[, 2]
y_dodge <- df[, 3] / 2
y_label < df[, 3]
ggplot(df, aes(x = x, 
               y = df[, 3], 
               fill = df[, 1])) +
  geom_bar(stat = "identity", 
           position = "dodge") +
  scale_y_continuous(breaks = y_label,
                     labels = format(y_label, big.mark = ",")) +
#  N <- nrow(df)
#  index <- as.vector(matrix(1:N, nrow = 2)[2:1, ])
# y_label <- unlist(tapply(df[, 3], 
#                          df[, 2],
#                          rev))
  geom_text(aes(y = y_dodge), 
#            label = format(df[index, "Freq"], big.mark = ","), 
            label = ifelse(y_label == 0, "", y_label),
            position = position_dodge(width = 0.9))
}
barplot_gg_dodge(Vote_seoul_df) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1])
```

<P style = "page-break-before:always">

#### Fill

```{r, Fill}
barplot_gg_fill <- function(df){
n_fill <- length(levels(df[, 1]))
x <- df[, 2]
y_fill <- unlist(tapply(df[, 3], 
                        x, 
                        function(x){cumsum(x) / sum(x)}))
p_fill <- unlist(tapply(df[, 3], 
                        x, 
                        function(x){(cumsum(x) - x / 2) / sum(x)}))
ggplot(df, aes(x = x, 
               y = df[, 3], 
               fill = df[, 1])) +
  geom_bar(stat = "identity", 
           position = position_fill(reverse = TRUE)) +
  scale_y_continuous(breaks = y_fill,
                     labels = format(y_fill * 100,
                                     digits = 2,
                                     nsmall = 1)) +
  geom_text(aes(y = p_fill), 
            label = format(ifelse(df[, 3] == 0, "", df[, 3]), 
                           big.mark = ","), 
            position = "identity")
}
barplot_gg_fill(Vote_seoul_df) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1])
```

### barplot_gg

<P style = "page-break-before:always">

```{r, barplot_gg, message = FALSE}
barplot_gg <- function(x, 
                       position){
  switch(position,
         stack = barplot_gg_stack(x),
         dodge = barplot_gg_dodge(x),
         fill = barplot_gg_fill(x))
}
```

<P style = "page-break-before:always">

```{r, seoul_stack, fig.width = 6, height = 4.5}
bar_seoul_stack <- barplot_gg(Vote_seoul_df, 
                              position = "stack") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("서울의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
# ggsave("../pics/sejong_seoul_barplot_stack_ggplotv2.png", bar_seoul_stack, width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

```{r, seoul_dodge, fig.width = 6, height = 4.5}
bar_seoul_dodge <- barplot_gg(Vote_seoul_df, 
                              position = "dodge") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("서울의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
# ggsave("../pics/sejong_seoul_barplot_dodge_ggplotv2.png", bar_seoul_dodge, width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

```{r, seoul_fill, fig.width = 6, height = 4.5}
bar_seoul_fill <- barplot_gg(Vote_seoul_df, 
                             position = "fill") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("서울의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
# ggsave("../pics/sejong_seoul_barplot_fill_ggplotv2.png", bar_seoul_fill, width = 6, height = 4.5, dpi = 72)
dump(c("barplot_gg","barplot_gg_stack", "barplot_gg_dodge", "barplot_gg_fill"), 
     file = "./barplot_gg.R")
```

<P style = "page-break-before:always">

### mosaic plot

#### Data

```{r, message = FALSE}
Vote_seoul_Class_df <- Vote_seoul_Class %>%
  as.data.frame 
N <- length(levels(Vote_seoul_Class_df[, 1]))
Vote_seoul_Class_p_df <- Vote_seoul_Class_df %>%
  `[`(, 3) %>%
  proportions %>%
  data.frame(Vote_seoul_Class_df[1:2], "Prop" = .)
Vote_seoul_Class_p_df$width <- tapply(Vote_seoul_Class_p_df[, 3], Vote_seoul_Class_p_df[, 2], sum) %>%
  rep(each = N)
Vote_seoul_Class_p_df$height <- unlist(tapply(Vote_seoul_Class_p_df$Prop,
                                              Vote_seoul_Class_p_df[, 2],
                                              proportions)) 
Vote_seoul_Class_p_df$label_height <- unlist(tapply(Vote_seoul_Class_p_df$height,
                                                    Vote_seoul_Class_p_df[, 2], 
                                                    function(x) cumsum(x) - x / 2))
Vote_seoul_Class_p_df$y_breaks <- unlist(tapply(Vote_seoul_Class_p_df$height,
                                                Vote_seoul_Class_p_df[, 2], 
                                                cumsum))
Vote_seoul_Class_p_df$center <- tapply(Vote_seoul_Class_p_df[, 3], Vote_seoul_Class_p_df[, 2], sum) %>%  pos %>% rep(each = N)
```


```{r}
#> y축에 너무 눈금이 많이 설정되지 않도록 조치
Vote_seoul_Class_p_m <- tapply(Vote_seoul_Class_p_df[, 3], Vote_seoul_Class_p_df[, 2], sum)
x_breaks <- c(0, ifelse(cumsum(Vote_seoul_Class_p_m) < 0.1, 0.0, cumsum(Vote_seoul_Class_p_m)))
x_label <- format(x_breaks * 100, 
                  digits = 3, 
                  nsmall = 1)
y_breaks <- Vote_seoul_Class_p_df$y_breaks
delta <- (max(y_breaks) - min(y_breaks)) / 20
y_breaks_sort <- sort(y_breaks)
index <- which(diff(y_breaks_sort)  > delta)
y_breaks <- c(0, y_breaks_sort[c(index, length(y_breaks_sort))])
y_label <- format(y_breaks * 100,
                  digits = 2,
                  nsmall = 1)
```

<P style = "page-break-before:always">

```{r, mosaic plot for seoul ggplot, fig.width = 6, fig_height = 4.5}
m1 <- ggplot(Vote_seoul_Class_p_df, 
             aes(x = center, 
                 y = height, 
                 width = width)) + 
  geom_bar(aes(fill = Vote_seoul_Class_p_df[, 1]), 
           stat = "identity", 
           col = "white", 
           size = 2, 
           position = position_stack(reverse = TRUE))
m1
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
m2 <- m1 + 
  theme_bw(base_family = "KoPubWorldDotum Medium")
m2
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
m3 <- m2 + 
  geom_text(aes(x = center, 
                y = 1.05), 
            label = Vote_seoul_Class_p_df[, 2], 
            family = "KoPubWorldDotum Medium")
m3
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
m4 <- m3 + 
  geom_text(aes(x = center, 
                y = label_height), 
            label = format(Vote_seoul_Class_df[, 3], 
                           big.mark = ","), 
            position = position_identity())
m4
```

<P style = "page-break-before:always">

```{r, fig.width = 6, fig_height = 4.5}
m5 <- m4 + 
  scale_x_continuous(name = "계급(누적 %)", 
                     breaks = x_breaks, 
                     label = x_label) + 
  scale_y_continuous(name = "찬반(%)",
                     breaks = y_breaks,
                     label = y_label) + 
  scale_fill_manual(name = "찬반", 
                    values = rainbow(2)[2:1], 
                    labels = Vote_seoul_df[, 1], 
                    guide = guide_legend()) +
  ggtitle("서울의 찬반")
m5
```

<!--
<P style = "page-break-before:always">
-->

#### mosaic_gg_new

```{r mosaic_gg_new, fig.width = 6, fig_height = 4.5}
mosaic_gg_new <- function(tbl_df){
#  tbl_df <- tbl %>%
#  as.data.frame
#  N <- length(levels(tbl_df[, 1]))
#> data for mosaic coordinates
  pos <- function(x){
    cumsum(x) - x / 2
  }
  tbl_p_df <- tbl_df %>%
  `[`(, 3) %>%
  proportions %>%
  data.frame(tbl_df[1:2], "Prop" = .)
  tbl_p_df$width <- tapply(tbl_p_df[, 3], tbl_p_df[, 2], sum) %>% 
    rep(each = N)
  tbl_p_df$height <- unlist(tapply(tbl_p_df[, 3], 
                                   tbl_p_df[, 2], 
                                   proportions))
  tbl_p_df$label_height <- unlist(tapply(tbl_p_df$height, 
                                         tbl_p_df[, 2], 
                                         function(x) cumsum(x) - x / 2))
  tbl_p_df$y_breaks <- unlist(tapply(tbl_p_df$height, 
                                     tbl_p_df[, 2], 
                                     cumsum))
  tbl_p_df$center <- tapply(tbl_p_df[, 3], tbl_p_df[, 2], sum) %>%
    pos %>%
    rep(each = N)
########## 
#> breaks and labels
  tbl_p_m <- tapply(tbl_p_df[, 3], tbl_p_df[, 2], sum)
  x_breaks <- c(0, ifelse(cumsum(tbl_p_m) < 0.1, 0.0, cumsum(tbl_p_m)))
  x_label <- format(x_breaks * 100, 
                    digits = 3, 
                    nsmall = 1)
  y_breaks <- tbl_p_df$y_breaks
  delta <- (max(y_breaks) - min(y_breaks)) / 20
  y_breaks_sort <- sort(y_breaks)
  diff(y_breaks_sort) < delta 
  index <- which(diff(y_breaks_sort)  > delta)
  y_breaks <- c(0, y_breaks_sort[c(index, length(y_breaks_sort))])
  y_label <- format(y_breaks * 100,
                    digits = 2,
                    nsmall = 1)
#> 
##########
m <- 
  ggplot(tbl_p_df, 
         aes(x = center, 
             y = height, 
             width = width)) + 
  geom_bar(aes(fill = tbl_df[, 1]), 
           stat = "identity", 
           col = "white", 
           size = 1, 
           position = position_stack(reverse = TRUE)) +
#  geom_text(aes(x = center, 
#                y = 1.05), 
#            family = "KoPubWorldDotum Medium",
#            label = tbl_p_df[, 2]) +
  geom_text(aes(x = center, 
                y = label_height), 
            label = format(ifelse(tbl_df[, 3] == 0, "", tbl_df[, 3]), 
                           big.mark = ","), 
            position = position_identity()) +
  scale_x_continuous(breaks = x_breaks, 
                     label = x_label) + 
  scale_y_continuous(breaks = y_breaks,
                     label = y_label) + 
  theme(plot.margin = unit(c(1, 2, 1, 1), "lines"))
list(m = m, df = tbl_df, p_df = tbl_p_df)
}
dump(list = "mosaic_gg_new", file = "./mosaic_gg_new.R")
```

<!--
<P style = "page-break-before:always">
-->

```{r, message = FALSE, fig.width = 6, fig_height = 4.5}
source("mosaic_gg_new.R")
m_seoul_list <- mosaic_gg_new(Vote_seoul_Class_df) 
m <- m_seoul_list$m 
df <- m_seoul_list$df
p_df <- m_seoul_list$p_df
m + 
  geom_text(aes(x = center, y = 1.05), 
            family = "KoPubWorldDotum Medium",
            label = p_df[, 2]) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(title = "서울의 찬반", x = "계급(누적 %)", y = "찬반(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold")) 
ggsave("../pics/sejong_seoul_mosaic_ggplot.png", width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

## 지역별 관료들의 찬반(서울 제외)

```{r, local bureaus}
Vote_Region_bureaus %>%
  `[`(, -1) %>%
  kable(caption = "지역별 관료들의 찬반(서울 제외)")
# kable(Vote_Region_bureaus[, -1], 
#       caption = "지역별 관료들의 찬반(서울 제외)")
Vote_Region_bureaus %>%
  `[`(, -1) %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 1, nsmall = 1) %>%
  kable(align = "r", caption = "지역별 관료들의 찬반(서울 제외, %)")
# kable(format(prop.table(Vote_Region_bureaus[, -1], 
#                         margin = 2)*100, 
#              digits = 1, 
#              nsmall = 1), 
#       align = "r", 
#       caption = "지역별 관료들의 찬반(서울 제외, %)")
```

<P style = "page-break-before:always">

### 막대그래프

```{r, geom_bar for regional bureaus, fig.width = 9, fig_height = 4.5}
# Vote_Region_bureaus_df <- as.data.frame(Vote_Region_bureaus[, -1])
Vote_Region_bureaus_df <- aggregate(Counts ~ Vote + Region,
                                    data = subset(sejong_ref, 
                                                  Class_2 == "관료" & Region != "서울"), 
                                    FUN = sum)
barplot_gg(Vote_Region_bureaus_df, 
           position = "stack") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "지역", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("지방 관료의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_bureaus_barplot_stack_ggplot.png", width = 9, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

### mosaic plot

```{r, mosaic plot for region ggplot, fig.width = 9, fig_height = 4.5}
Vote_Region_bureaus_df %>%
  str
Vote_Region_bureaus_df$Region %<>%
   factor
# mosaic_gg(as.data.frame(Vote_Region_bureaus[, -1])) +
m_Rb_list <- 
  mosaic_gg_new(Vote_Region_bureaus_df)
m_Rb <- m_Rb_list$m 
df_Rb <- m_Rb_list$df
p_df_Rb <- m_Rb_list$p_df
m_Rb + 
  geom_text(aes(x = center, y = 1.05), 
            family = "KoPubWorldDotum Medium",
            label = p_df_Rb[, 2]) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(title = "지방관료의 찬반", x = "지역별 관료들의 비중(누적 %)", y = "찬반(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_bureaus_mosaic_ggplot.png", width = 9, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

## 품관촌민들의 지역별 찬반

### 막대그래프

```{r, geom_bar for commons, fig.width = 10, fig_height = 4.5}
# Vote_Region_commons_df <- as.data.frame(Vote_Region_commons)
Vote_Region_commons_df <- aggregate(Counts ~ Vote + Region,
                                    data = subset(sejong_ref, 
                                                  Class_2 == "품관촌민"),
                                    FUN = sum)
barplot_gg(Vote_Region_commons_df, 
           position = "stack") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "지역", y = "집계") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("품관촌민의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_commons_barplot_stack_ggplot.png", width = 9, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

### mosaic plot

```{r, mosaic plot for commons ggplot, fig.width = 12, fig_height = 4.5}
Vote_Region_commons_df %>%
  str
Vote_Region_commons_df$Region %<>%
   factor
m_Rc_list <- 
  mosaic_gg_new(Vote_Region_commons_df)
m_Rc <- m_Rc_list$m 
df_Rc <- m_Rc_list$df
p_df_Rc <- m_Rc_list$p_df
m_Rc + 
  geom_text(aes(x = center, y = 1.05), 
            family = "KoPubWorldDotum Medium",
            label = p_df_Rc[, 2]) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(title = "품관촌민의 찬반", x = "지역별 품관촌민의 비중(누적%)", y = "찬반(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_commons_mosaic_ggplot.png", width = 12, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

## 충청도

관료들의 찬반과 품관촌민의 찬반이 다른 곳.

```{r, chungcheong}
Vote_chung_Class %>%
  format(big.mark = ",") %>% 
  kable(align = "r", caption = "충청도 사례")
# kable(format(Vote_chung_Class, 
#              big.mark = ","), 
#       caption = "충청도 사례", 
#       align = "r")
Vote_chung_Class %>%
  prop.table(margin = 2) %>%
  `*`(100) %>%
  format(digits = 3, nsmall = 1) %>%
  kable(align = "r", caption = "충청도 사례")
# kable(format(prop.table(Vote_chung_Class, 
#                         margin = 2)*100, 
#              digits = 3, nsmall = 1), 
#       caption = "충청도 사례", 
#       align = "r")
```

### 막대그래프

```{r, geom_bar fill for Chungcheong, fig.width = 6, fig_height = 4.5}
# Vote_chung_Class_df <- as.data.frame(Vote_chung_Class)
Vote_chung_Class_df <- aggregate(Counts ~ Vote + Class,
                                    data = subset(sejong_ref, 
                                                  Region == "충청"), 
                                    FUN = sum)
barplot_gg(Vote_chung_Class_df, 
           position = "fill") +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(x = "계급", y = "집계(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  ggtitle("충청도의 찬반") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_chungcheong_barplot_fill_ggplot.png", width = 6, height = 4.5, dpi = 72)
```

<P style = "page-break-before:always">

### mosaic plot

```{r, mosaic plot for chungcheong ggplot, fig.width = 12, fig_height = 4.5}
m_chung_list <- 
  mosaic_gg_new(as.data.frame(Vote_chung_Class[, -1]))
m_chung <- m_chung_list$m 
df_chung <- m_chung_list$df
p_df_chung <- m_chung_list$p_df
m_chung + 
  geom_text(aes(x = center, y = 1.05), 
            family = "KoPubWorldDotum Medium",
            label = p_df_chung[, 2]) +
  theme_bw(base_family = "KoPubWorldDotum Medium") +
  labs(title = "충청도의 찬반", x = "계급(누적%)", y = "찬반(%)") +
  scale_fill_manual(name = "찬반", values = rainbow(2)[2:1]) +
  theme(text = element_text(family = "KoPubWorldDotum Medium"),
        plot.title = element_text(hjust = 0.5, 
                                  size = 18, 
                                  family = "KoPubWorldDotum Bold"))
ggsave("../pics/sejong_chungcheong_mosaic_ggplot.png", width = 12, height = 4.5, dpi = 72)
```

## 자료 정리

```{r, save}
save.image(file = "./sejong_ggplot.RData")
```

