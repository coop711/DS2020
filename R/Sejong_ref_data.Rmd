---
title: "King Sejong's National Referendum on Tax Reform"
author: "coop711"
date: "`r Sys.Date()`"
output: html_document
---

## Data

### Reading Data 

원본 자료는 세종실록 인터넷 판에 기록으로 있는데(세종12년 8월10일, 호조에서 공법에 대한 여러 의논을 갖추어 아뢰다) 3-4명이 팀을 이루어 요약할 때 1-2시간 정도 걸린다.

```{r, out.width = "90%"}
knitr::include_graphics("../pics/sejong_silok_12-08-10.png")
```

아래 <표 1>은 오기수 교수님의 요약본을 옮긴 것이다. 전형적인 테이블 구조이나 아직 깔끔한(tidy) 데이터로 정리하지 않은 상태이다. 찬반 집계를 value 로 간주할 때, 각 value 들은 어느 지역, 어떤 계급의 사람들이 찬성이나 반대를 한 결과를 합산한 것이다. 지역, 계급, 찬반, 집계의 네 가지 변수가 등장하는 데 이를 집계에 대하여 정리하면 깔끔한 데이터가 된다. 

```{r, out.width = "75%"}
knitr::include_graphics("../pics/sejong_ref_data.png")
```


```{r, setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
options(width = 180)
```

`sejong_ref.txt` 는 위의 표를 깔끔한 구조로 정리한 텍스트 파일이다.

```{r, reading data}
sejong_ref <- read.table("../data/sejong_ref.txt", 
                         header = TRUE, 
                         stringsAsFactors = FALSE)
str(sejong_ref)
# pander(sejong_ref)
kable(sejong_ref[4:1])
```

### Factor conversion

We need Vote, Class, Region as `factor`s. If you leave them as `chr`, it will be coerced to factor when you tabulate it according to alphabetical order, which is not what you want. So, use `factor()` to convert them. `

```{r, Vote as factor}
sejong_ref$Vote <- factor(sejong_ref$Vote, 
                          levels = c("찬성","반대"))
```

You can check that `labels = ` is not necessary if same as levels. Continue with Class and Region_

```{r, Class as factor}
Class_levels <- c("대신_등","3품이하현직", "3품이하전직", "수령", "품관촌민")
Class_labels <- c("대신 등","3품이하현직", "3품이하전직", "수령", "품관촌민")
sejong_ref$Class <- factor(sejong_ref$Class, 
                           levels = Class_levels, 
                           labels = Class_labels)
```

```{r, Region as factor}
Region_levels <- c("서울","유후사", "경기", "평안", "황해", "충청", "강원", "함길", "경상", "전라")
sejong_ref$Region <- factor(sejong_ref$Region, 
                            levels = Region_levels)
```

```{r, data in dataframe}
str(sejong_ref)
kable(sejong_ref[4:1])
```

### Array

We can set up the data as an array

```{r, array structure}
sejong_ref_array <- xtabs(Counts ~ Vote + Class + Region, 
                           data = sejong_ref)
str(sejong_ref_array)
sejong_ref_array
```

## Votes

### Total

Check the total Vote with xtabs()

```{r, total yes or no}
Vote_total <- xtabs(Counts ~ Vote, 
                    data = sejong_ref)
kable(t(as.matrix(Vote_total)), 
      caption = "Total")
# format(prop.table(Vote_total)*100, digits = 3, nsmall = 1)
kable(t(as.matrix(format(prop.table(Vote_total) * 100, 
                         digits = 3, 
                         nsmall = 1))), 
      caption = "Percentage", 
      align = rep("r", 2))
Vote_total.2 <- apply(sejong_ref_array, 1, sum)
# kable(t(as.matrix(Vote_total.2)))
kable(t(as.matrix(Vote_total.2)), 
      caption = "Total")
```

### Vote by Class

```{r, by Class}
Vote_Class <- xtabs(Counts ~ Vote + Class, 
                    data = sejong_ref)
kable(Vote_Class, 
      caption = "계급별")
Vote_Class_a <- apply(sejong_ref_array, 1:2, sum)
kable(Vote_Class_a, 
      caption = "계급별")
```

### Commons vs Bureaucrats

We need to analyse Commons separately. 

```{r, commons vs bureaus}
sejong_ref$Class_2 <- factor(ifelse(sejong_ref$Class == "품관촌민", 
                                       "품관촌민", "관료"), 
                                levels = c("관료", "품관촌민"))
kable(sejong_ref[c(4, 3, 5, 2, 1)])
str(sejong_ref)
```

Compare the Votes by `Class_2`,  (Bureaucrats vs Commons)

```{r, Vote by Class_2}
Vote_Class_2 <- xtabs(Counts ~ Vote + Class_2, 
                      data = sejong_ref)
kable(Vote_Class_2, caption = "관료와 품관촌민")
Vote_Class_2_a <- cbind("관료" = rowSums(Vote_Class_a[, -5]),
                        "품관촌민" =  Vote_Class_a[, 5])
kable(Vote_Class_2_a, caption = "관료와 품관촌민")
```

Add subtotals to the margins, 

```{r, subtotals}
Vote_Class_2_am <- addmargins(Vote_Class_2)
kable(Vote_Class_2_am)
```

Compute the marginal proportions. Note the use of `digits = 3` and `nsmall = 1`.

```{r, proportions}
kable(format(prop.table(Vote_Class_2, margin = 2) * 100, 
             digits = 3, nsmall = 1), 
      caption = "관료와 품관촌민", align = rep("r", 2))
```

### Votes by Region with respect to Class_2 

Count the Vote by Region Class_2 wise.

```{r, Region w.r.t Class_2}
Class_2 <- sejong_ref$Class_2
Vote_Region_bureaus <- xtabs(Counts ~ Vote + Region, 
                             data = sejong_ref, 
                             Class_2 == "관료", 
                             drop = TRUE)
kable(Vote_Region_bureaus, caption = "투표(관료)")
# xtabs(Counts ~ Vote + Region, data = sejong_ref[Class_2 == "Bureaus", ], drop = TRUE)
Vote_Region_commons <- xtabs(Counts ~ Vote + Region, 
                             data = sejong_ref, 
                             Class_2 == "품관촌민", 
                             drop = TRUE)
kable(Vote_Region_commons, caption = "투표(품관촌민)")
```

Seoul has three times more Bureaucrats than other Regions, so analyse further.

```{r, Seoul}
Region <- sejong_ref$Region
Vote_seoul_Class <- xtabs(Counts ~ Vote + Class, 
                          data = sejong_ref, 
                          Region == "서울", drop = TRUE)
kable(Vote_seoul_Class, caption = "서울")
kable(format(prop.table(Vote_seoul_Class, margin = 2) * 100, 
             digits  = 3, nsmall = 1), 
      caption = "서울", align = rep("r", 3))
```

Chungcheong's case.

```{r, Chungcheong}
Vote_chung_Class <- xtabs(Counts ~ Vote + Class, 
                          data = sejong_ref, 
                          Region == "충청", drop = TRUE)
kable(format(prop.table(Vote_chung_Class, margin = 2) * 100, 
             digits = 3, nsmall = 1), 
      caption = "충청", align = rep("r", 3))
```

- Save the working directory image.

```{r, save}
save.image(file = "sejong_ref_data.RData")
```